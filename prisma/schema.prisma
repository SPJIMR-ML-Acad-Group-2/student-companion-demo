generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
  // directUrl = env("DIRECT_URL")
}

// ─── Programmes & Batches ──────────────────────────────

model Programme {
  id       Int     @id @default(autoincrement())
  code     String  @unique // PGP, PGPBM — prefix for roll numbers
  name     String // PGDM, PGDM (BM)
  fullName String // Post Graduate Diploma in Management
  batches  Batch[]
  Term     Term[]
}

model Batch {
  id           Int        @id @default(autoincrement())
  programmeId  Int
  activeTermId Int?
  name         String // "PGDM 2025-27"
  startYear    Int // 2025
  endYear      Int // 2027
  isActive     Boolean    @default(true)
  programme    Programme  @relation(fields: [programmeId], references: [id])
  activeTerm   Term?      @relation("ActiveTerm", fields: [activeTermId], references: [id])
  students     User[]
  divisions    Division[] @relation("BatchDivisions")

  @@unique([programmeId, startYear, endYear])
}

model Term {
  id          Int          @id @default(autoincrement())
  programmeId Int
  number      Int // 1, 2, 3...
  name        String // "Term 1", "Term 3"
  isActive    Boolean      @default(false) // Deprecated, use `activeTermId` on Batch
  programme   Programme    @relation(fields: [programmeId], references: [id])
  activeFor   Batch[]      @relation("ActiveTerm")
  CourseTerm  CourseTerm[]

  @@unique([programmeId, number])
}

// ─── Specialisations & Divisions ───────────────────────

model Specialisation {
  id        Int        @id @default(autoincrement())
  name      String // "Marketing", "Information Management & Analytics"
  code      String     @unique // MKT, IM, FIN, OPS
  divisions Division[] @relation("SpecDivisions")
  students  User[]     @relation("StudentSpecialisation")
  courses   Course[]   @relation("SpecCourses")
}

model Division {
  id               Int             @id @default(autoincrement())
  name             String // "A", "B", "MKT-A" — scoped by batch, NOT globally unique
  type             String // "core" | "specialisation"
  batchId          Int? // for core divisions — linked to batch
  specialisationId Int?
  batch            Batch?          @relation("BatchDivisions", fields: [batchId], references: [id])
  specialisation   Specialisation? @relation("SpecDivisions", fields: [specialisationId], references: [id])
  timetable        Timetable[]
  coreStudents     User[]          @relation("CoreDivision")
  specStudents     User[]          @relation("SpecDivision")

  @@unique([name, batchId])
}

// ─── Users & Faculty ───────────────────────────────────

model User {
  id               Int             @id @default(autoincrement())
  name             String
  email            String          @unique
  role             String // student | programme_office
  rollNumber       String?         @unique // PGP-25-001, PGPBM-25-003
  batchId          Int?
  coreDivisionId   Int?
  specialisationId Int?
  specDivisionId   Int?
  batch            Batch?          @relation(fields: [batchId], references: [id])
  coreDivision     Division?       @relation("CoreDivision", fields: [coreDivisionId], references: [id])
  specialisation   Specialisation? @relation("StudentSpecialisation", fields: [specialisationId], references: [id])
  specDivision     Division?       @relation("SpecDivision", fields: [specDivisionId], references: [id])
  attendance       Attendance[]
  createdAt        DateTime        @default(now())
}

model Faculty {
  id           Int             @id @default(autoincrement())
  name         String
  email        String          @unique
  teachingArea String? // e.g. "Finance and Accounting", "Marketing"
  courses      FacultyCourse[]
  timetable    Timetable[]
}

model FacultyCourse {
  id        Int     @id @default(autoincrement())
  facultyId Int
  courseId  Int
  faculty   Faculty @relation(fields: [facultyId], references: [id])
  course    Course  @relation(fields: [courseId], references: [id])

  @@unique([facultyId, courseId])
}

// ─── Courses & Timetable ───────────────────────────────

model CourseTerm {
  id       Int    @id @default(autoincrement())
  courseId Int
  termId   Int
  course   Course @relation(fields: [courseId], references: [id])
  term     Term   @relation(fields: [termId], references: [id])

  @@unique([courseId, termId])
}

model Course {
  id               Int             @id @default(autoincrement())
  code             String          @unique
  name             String
  totalSessions    Int
  credits          Int             @default(3)
  type             String          @default("core") // core | elective | specialisation
  specialisationId Int?
  specialisation   Specialisation? @relation("SpecCourses", fields: [specialisationId], references: [id])
  courseTerms      CourseTerm[]
  facultyCourses   FacultyCourse[]
  timetable        Timetable[]
}

model Timetable {
  id            Int          @id @default(autoincrement())
  divisionId    Int
  courseId      Int
  facultyId     Int?
  date          String // YYYY-MM-DD (specific date — timetable changes weekly)
  slotNumber    Int // 1-8 (fixed slots)
  startTime     String // from FIXED_SLOTS
  endTime       String // from FIXED_SLOTS
  sessionNumber Int? // sequential session # for display
  isConducted   Boolean      @default(false)
  division      Division     @relation(fields: [divisionId], references: [id])
  course        Course       @relation(fields: [courseId], references: [id])
  faculty       Faculty?     @relation(fields: [facultyId], references: [id])
  attendance    Attendance[]

  @@unique([divisionId, date, slotNumber])
}

// ─── Attendance ────────────────────────────────────────

model Attendance {
  id          Int       @id @default(autoincrement())
  timetableId Int
  studentId   Int
  status      String // P | AB | LT | P# (sanctioned leave)
  swipeTime   String? // HH:mm:ss
  timetable   Timetable @relation(fields: [timetableId], references: [id])
  student     User      @relation(fields: [studentId], references: [id])
  createdAt   DateTime  @default(now())

  @@unique([timetableId, studentId])
}
