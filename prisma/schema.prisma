generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Programmes & Batches ──────────────────────────────

model Programme {
  id       Int     @id @default(autoincrement())
  code     String  @unique  // PGP, PGPBM — prefix for roll numbers
  name     String           // PGDM, PGDM (BM)
  fullName String           // Post Graduate Diploma in Management
  batches  Batch[]
}

model Batch {
  id          Int       @id @default(autoincrement())
  programmeId Int
  name        String    // "PGDM 2025-27"
  startYear   Int       // 2025
  endYear     Int       // 2027
  isActive    Boolean   @default(true)
  programme   Programme @relation(fields: [programmeId], references: [id])
  terms       Term[]
  students    User[]
  divisions   Division[] @relation("BatchDivisions")

  @@unique([programmeId, startYear, endYear])
}

model Term {
  id        Int      @id @default(autoincrement())
  batchId   Int
  number    Int      // 1, 2, 3...
  name      String   // "Term 1", "Term 3"
  startDate String?  // YYYY-MM-DD
  isActive  Boolean  @default(false)
  batch     Batch    @relation(fields: [batchId], references: [id])
  courses   Course[]

  @@unique([batchId, number])
}

// ─── Specialisations & Divisions ───────────────────────

model Specialisation {
  id        Int        @id @default(autoincrement())
  name      String     // "Marketing", "Information Management & Analytics"
  code      String     @unique  // MKT, IM, FIN, OPS
  divisions Division[] @relation("SpecDivisions")
  students  User[]     @relation("StudentSpecialisation")
  courses   Course[]   @relation("SpecCourses")
}

model Division {
  id               Int             @id @default(autoincrement())
  name             String          // "A", "B", "MKT-A" — scoped by batch, NOT globally unique
  type             String          // "core" | "specialisation"
  batchId          Int?            // for core divisions — linked to batch
  specialisationId Int?
  batch            Batch?          @relation("BatchDivisions", fields: [batchId], references: [id])
  specialisation   Specialisation? @relation("SpecDivisions", fields: [specialisationId], references: [id])
  timetable        Timetable[]
  sessions         Session[]
  coreStudents     User[]          @relation("CoreDivision")
  specStudents     User[]          @relation("SpecDivision")

  @@unique([name, batchId])
}

// ─── Users & Faculty ───────────────────────────────────

model User {
  id               Int             @id @default(autoincrement())
  name             String
  email            String          @unique
  role             String          // student | programme_office
  rollNumber       String?         @unique  // PGP-25-001, PGPBM-25-003
  batchId          Int?
  coreDivisionId   Int?
  specialisationId Int?
  specDivisionId   Int?
  batch            Batch?          @relation(fields: [batchId], references: [id])
  coreDivision     Division?       @relation("CoreDivision", fields: [coreDivisionId], references: [id])
  specialisation   Specialisation? @relation("StudentSpecialisation", fields: [specialisationId], references: [id])
  specDivision     Division?       @relation("SpecDivision", fields: [specDivisionId], references: [id])
  attendance       Attendance[]
  createdAt        DateTime        @default(now())
}

model Faculty {
  id           Int             @id @default(autoincrement())
  name         String
  email        String          @unique
  teachingArea String?         // e.g. "Finance and Accounting", "Marketing"
  courses      FacultyCourse[]
  timetable    Timetable[]
}

model FacultyCourse {
  id        Int     @id @default(autoincrement())
  facultyId Int
  courseId   Int
  faculty   Faculty @relation(fields: [facultyId], references: [id])
  course    Course  @relation(fields: [courseId], references: [id])

  @@unique([facultyId, courseId])
}

// ─── Courses & Timetable ───────────────────────────────

model Course {
  id             Int              @id @default(autoincrement())
  code           String           @unique
  name           String
  totalSessions  Int
  credits        Int              @default(3)
  termId         Int?
  type           String           @default("core")  // core | elective | specialisation
  specialisationId Int?
  term           Term?            @relation(fields: [termId], references: [id])
  specialisation Specialisation?  @relation("SpecCourses", fields: [specialisationId], references: [id])
  facultyCourses FacultyCourse[]
  timetable      Timetable[]
  sessions       Session[]
}

model Timetable {
  id         Int      @id @default(autoincrement())
  divisionId Int
  courseId   Int
  facultyId  Int?
  date       String   // YYYY-MM-DD (specific date — timetable changes weekly)
  slotNumber Int      // 1-8 (fixed slots)
  startTime  String   // from FIXED_SLOTS
  endTime    String   // from FIXED_SLOTS
  division   Division @relation(fields: [divisionId], references: [id])
  course     Course   @relation(fields: [courseId], references: [id])
  faculty    Faculty? @relation(fields: [facultyId], references: [id])

  @@unique([divisionId, date, slotNumber])
}

// ─── Sessions & Attendance ─────────────────────────────

model Session {
  id            Int          @id @default(autoincrement())
  courseId      Int
  divisionId    Int
  date          String       // YYYY-MM-DD
  slotNumber    Int
  sessionNumber Int?         // sequential session # for display
  course        Course       @relation(fields: [courseId], references: [id])
  division      Division     @relation(fields: [divisionId], references: [id])
  attendance    Attendance[]
  createdAt     DateTime     @default(now())

  @@unique([courseId, divisionId, date, slotNumber])
}

model Attendance {
  id        Int      @id @default(autoincrement())
  sessionId Int
  studentId Int
  status    String   // P | AB | LT | P# (sanctioned leave)
  swipeTime String?  // HH:mm:ss
  session   Session  @relation(fields: [sessionId], references: [id])
  student   User     @relation(fields: [studentId], references: [id])
  createdAt DateTime @default(now())

  @@unique([sessionId, studentId])
}
